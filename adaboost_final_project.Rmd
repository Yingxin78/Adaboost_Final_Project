---
title: "Adaboost Final Project"
author: "Yingxin Zhang"
date: "April 26, 2020"
output: html_document
---

## Adaboost

Boosting is an approach to machine learning based on the idea of creating a highly accurate prediction rule by combining many relatively weak and inaccurate rules. The AdaBoost algorithm of Freund and Schapire was the first practical boosting algorithm, and remains one of the most widely used and studied, with applications in numerous fields.

The main idea behind Adaboost is to combine multiple classifiers, called weak learners, in a unique classifier through a weighted linear combination. It iteratively extracts a weak classifier and assigns a weight to the classifier according to its relevance. Each weak learner minimizes an weighted sum error. At each iteration, a weight comes from previous error and is assigned to each sample.

## Data

Using the 2016 Parent and Family Involvement in Education Survey Data provided by the National Center for Education Statistics, I would like to use AdaBoost to predict whether a student is currently studying in a charter school or not. The data is pulled down from eDAT (https://nces.ed.gov/OnlineCodebook), under the NHES (National Household Education Survey).
There has been a debate on whether school choice in the United States makes school segregation worse. Since charter school is one of the most popular of the school choice options, I would like to figure out the characteristics of students studying in charter schools and see whether there are any racial, socioeconomic, and other biases. The prediction will mainly base on 1) student's background: e.g. race, sex, birthplace, health condition, whether the student suffers from learning disabilities and disorders, whether the student has repeated any grade, suspended or expelled from school, etc.; 2) student's family background: e.g. total people in household, total household income, whether the family own/rent their house, whether the family receiving benefits from welfare plans, etc.

```{r rmarkdown-setup, warning= FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align = "center")

library(tidyverse)
library(tidymodels)
library(ROSE)
library(adabag)
library(caret)
library(knitr)
library(grid)
library(gridExtra)
```

```{r random seed, warning= FALSE, message = FALSE}
set.seed(20200426)
```



# Data Loading


Load data and select varibles

```{r data loading, warning= FALSE, message = FALSE}
# load R Data File
load("data/nhes_16_pfi_v1_0.rdata")

# Create vector of selected variables
# There are 329 variables in the original survey data. I choose 38 of them to include in my research.
keepvars <- c(
   "SCHRTSCHL",
   "SPERFORM",
   "SEREPEAT",
   "SESUSOUT",
   "SESUSPIN",
   "SEEXPEL",
   "SEFUTUREX",
   "FOLIBRAYX",
   "FOBOOKSTX",
   "FOCONCRTX",
   "FOMUSEUMX",
   "FOZOOX",
   "FOGROUPX",
   "FOSPRTEVX",
   "HDHEALTH",
   "HDRECSER",
   "CPLCBRTH",
   "CHISPAN",
   "CAMIND",
   "CASIAN",
   "CBLACK",
   "CPACI",
   "CWHITE",
   "CHISPRM",
   "CSEX",
   "CENGLPRG",
   "HHTOTALXX",
   "HHMOM",
   "HHDAD",
   "HWELFTAN",
   "HWELFST",
   "HWIC",
   "HFOODST",
   "HMEDICAID",
   "HCHIP",
   "HSECN8",
   "TTLHHINC",
   "OWNRNTHB"
)

# Create new object containing only selected variables
df <- nhes_16_pfi_v1_0[keepvars]
```



# Data Processing

E4: I change all the "valid skip" reported to "no" for this variable, because based on the codebook for the original data, the "valid skip" reported here are the ones who study in private schools.

```{r SCHRTSCHL, warning= FALSE, message = FALSE}
df$SCHRTSCHL[df$SCHRTSCHL == "-1 Valid Skip"] <- "2 No"
table(df$SCHRTSCHL)
```


E8: I delete the 552 observations reported as "valid ship" for this variable, because according to the codebook, there are 552 observations skip from the first question in the survey.

```{r SEREPEAT, warning= FALSE, message = FALSE}
df <- df[!(df$SEREPEAT == "-1 Valid Skip"),]
table(df$SPERFORM)
```


The same 552 "valid skip" for every following variable are deleted.

```{r other varibles, warning= FALSE, message = FALSE}
table(df$SEREPEAT)
table(df$SESUSOUT)
table(df$SESUSPIN)
table(df$SEEXPEL)
table(df$SEFUTUREX)
```


E19: I create a new variable "SEDISP" based on three original variables: SESUSOUT (out of school suspension), SESUSPIN (in school suspension) and SEEXPEL (expelled). The new variable demonstrates whether the child had ever been punished by the school discipline before s/he started to study in the current school. The variable equals to 1 (yes) if the answer for any of the three original questions is yes, 2 (no) otherwise.

```{r SEDISP, warning= FALSE, message = FALSE}
df$SEDISP <- df$SESUSOUT
df$SESUSOUT <- NULL
df$SEDISP[(df$SESUSPIN == "1 Yes")] <- "1 Yes"
df$SESUSPIN <- NULL
df$SEDISP[(df$SEEXPEL == "1 Yes")] <- "1 Yes"
df$SEEXPEL <- NULL
table(df$SEDISP)
```


E48: The original survey question for this variable is "whether this child receiving services for his/her condition". The codebook tells me that the "condition" refers to the learning disabilities and disorders asked in the earlier questions, which include: intellectual disability, speech or language impairment, serious emotional disturbance, deafness or another hearing impairment, blindness or another visual impairment not corrected with glasses, orthopedic impairment, autism, Pervasive Developmental Disorder (PDD), Attention Deficit Disorder, ADD or ADHD, specific learning disability, developmental delay, traumatic brain injury, and other health impairment lasting 6 months or more.

I redefine this variable as whether this child has any learning disability. So, I change all the "yes" and "no" reported in the original question to "yes" and change all the "valid skip" to "no", because student without any disabilities or disorders do not need to answer this question.

```{r HDRECSER, warning= FALSE, message = FALSE}
df$HDRECSER[df$HDRECSER == "2 No"] <- "1 Yes"
df$HDRECSER[df$HDRECSER == "-1 Valid Skip"] <- "2 No"
table(df$HDRECSER)
```


E64: I change all the "valid skip" reported to "no" for this variable, because native English speakers and children who are not able to speak do not need to answer this question.

```{r CENGLPRG, warning= FALSE, message = FALSE}
df$CENGLPRG[df$CENGLPRG == "-1 Valid Skip"] <- "2 No"
table(df$CENGLPRG)
```


E112: I create a new variable "HWELFALL" based on seven original variables: HWELFTAN (received TANF in the past 12 months), HWELFST (received state welfare or family assistance in the past 12 months), HWIC (received WIC in the past 12 months), HFOODST (received Food Stamps in the past 12 months), HMEDICAID (received Medicaid in the past 12 months), HCHIP (received CHIP in the past 12 months), HSECN8 (received Section 8 in the past 12 months). The new variable demonstrates whether the family ever receive benefits from any welfare plans in the past 12 months. The variable equals to 1 (yes) if the answer for any of the seven original questions is yes, 2 (no) otherwise.

```{r HWELFALL, warning= FALSE, message = FALSE}
df$HWELFALL <- df$HWELFTAN
df$HWELFTAN <- NULL
df$HWELFALL[(df$HWELFST == "1 Yes")] <- "1 Yes"
df$HWELFST <- NULL
df$HWELFALL[(df$HWIC == "1 Yes")] <- "1 Yes"
df$HWIC <- NULL
df$HWELFALL[(df$HFOODST == "1 Yes")] <- "1 Yes"
df$HFOODST <- NULL
df$HWELFALL[(df$HMEDICAID == "1 Yes")] <- "1 Yes"
df$HMEDICAID <- NULL
df$HWELFALL[(df$HCHIP == "1 Yes")] <- "1 Yes"
df$HCHIP <- NULL
df$HWELFALL[(df$HSECN8 == "1 Yes")] <- "1 Yes"
df$HSECN8 <- NULL
table(df$HWELFALL)
```
```{r drop levles, warning= FALSE, message = FALSE}
df <- droplevels(df)
```



# Training

Split data set

```{r train test split, warning= FALSE, message = FALSE}
# create a split object
split <- initial_split(df, prop = 0.8)
# use the split object to create training and testing data
charter_training <- training(split)
charter_testing <- testing(split)
```


The data is highly unbalanced which contains only 6% of positive cases

```{r display frequencies, warning= FALSE, message = FALSE}
prop.table(table(df$SCHRTSCHL))
```


balance the data by oversampling

```{r displa, warning= FALSE, message = FALSE}
charter_training_balance <- ovun.sample(SCHRTSCHL~., data = charter_training, method = "both", p = 0.5ï¼Œ seed = 20200505)$data
table(charter_training_balance$SCHRTSCHL)
```


```{r train adaboost, warning= FALSE, message = FALSE}
# classification with adaboost
adaboost = boosting(SCHRTSCHL~., data=charter_training, boos=TRUE, mfinal=50, coeflearn = 'Breiman', control = rpart.control(cp=-1))
summary(adaboost)
```

```{r test adaboost, warning= FALSE, message = FALSE}
# prediction
pred = predict(adaboost, charter_testing)
# metric
print(pred$confusion)
```

```{r feature importance, warning= FALSE, message = FALSE}
adaboost$importance
```